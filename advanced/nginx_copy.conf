#user
nobody;
worker_processes
8;
error_log
/opt/nginx/logs/errer.log;
#error_log
logs/error.log
notice;
#error_log
logs/error.log
info;
#pid
logs/nginx.pid;
worker_rlimit_nofile
655350;
events
{
worker_connections
655350;
use
epoll;
multi_accept
on;
accept_mutex
off;
}
http
{
include
mime.types;
default_type
application/octet-stream;
#log_format
main
'$remote_addr
-
$remote_user
[$time_local]
"$request"
'
#'$status
$body_bytes_sent
"$http_referer"
'
#'"$http_user_agent"
"$http_x_forwarded_for"';
#access_log
logs/access.log
main;
#
性能优化参数
sendfile
on;
tcp_nopush
on;
tcp_nodelay
on;
reset_timedout_connection
on;
client_max_body_size
20M;
client_header_buffer_size
8k;
large_client_header_buffers
8
16k;
client_body_buffer_size
256k;
keepalive_timeout
65;
keepalive_requests
10000;
open_file_cache
max=500000
inactive=20s;
open_file_cache_valid
30s;
open_file_cache_min_uses
3;
open_file_cache_errors
on;
#
Gzip压缩优化
gzip
on;
gzip_min_length
1024;
gzip_comp_level
4;
gzip_types
text/plain
text/css
application/json
application/javascript
text/xml
application/xml
application/xml+rss
text/javascript
image/svg+xml;
gzip_vary
on;
gzip_proxied
any;
#后端管理接口的负载均衡配置
upstream
admin-api
{
server
10.44.48.84:8226;
keepalive
100;
keepalive_requests
10000;
keepalive_timeout
60s;
least_conn;
}
#文件预览的负载均衡配置
upstream
kkfile-api
{
server
10.44.48.84:8012;
}
#定时任务配置
upstream
xxl-job-admin{
server
10.44.48.84:8080;
}
upstream
flood_prevention-api{
server
10.44.48.84:8082;
}
server
{
listen
9080;
server_name
localhost;
#charset
koi8-r;
#access_log
logs/host.access.log
main;
root
html;
#前端页面代理
location
/
{
root
/opt/server/admin/admin-ui/dist;
index
index.html
index.htm;
if
($request_method
=
'OPTIONS')
{
return
204;
}
}
location
/bpm-ui/
{
alias
/opt/server/admin/bpm-ui/dist/;
}
#前端页面字体
#请从10.11.228.190/opt/server/config/font/复制文件;
location
/font/
{
alias
/opt/server/font/;
add_header
'Access-Control-Allow-Origin'
'*';
add_header
'Access-Control-Allow-Methods'
'GET,
POST,
OPTIONS';
add_header
'Access-Control-Allow-Headers'
'Origin,
Content-Type,
Accept,
Authorization';
}
#后台管理接口
location
/api/
{
proxy_pass
http://admin-api/;
proxy_set_header
Host
$host;
proxy_set_header
X-Real-IP
$remote_addr;
proxy_set_header
X-Forwarded-For
$proxy_add_x_forwarded_for;
proxy_set_header
X-Forwarded-Prefix
/api;
proxy_set_header
X-NginX-Proxy
true;
proxy_set_header
Upgrade
$http_upgrade;
proxy_set_header
Connection
"upgrade";
}
#后台管理接口的websocket
location
/api/ws/
{
proxy_pass
http://admin-api/ws/;
proxy_http_version
1.1;
proxy_set_header
Upgrade
$http_upgrade;
proxy_set_header
Connection
"upgrade";
proxy_set_header
Host
$host;
proxy_set_header
X-Real-IP
$remote_addr;
proxy_set_header
X-Forwarded-For
$proxy_add_x_forwarded_for;
proxy_set_header
X-Forwarded-Proto
$scheme;
proxy_headers_hash_max_size
4096;
proxy_headers_hash_bucket_size
640;
}
#文件预览
location
/kkfile-api/
{
proxy_pass
http://kkfile-api/;
proxy_set_header
Host
$host;
proxy_set_header
X-Real-IP
$remote_addr;
proxy_set_header
X-Forwarded-For
$proxy_add_x_forwarded_for;
proxy_set_header
Upgrade
$http_upgrade;
proxy_set_header
Connection
"upgrade";
add_header
'Access-Control-Allow-Origin'
'*';
add_header
'Access-Control-Allow-Methods'
'GET,
POST,
OPTIONS';
add_header
'Access-Control-Allow-Headers'
'Origin,
Content-Type,
Accept,
Authorization';
}
#定时任务配置
location
/xxl-job-admin/{
proxy_pass
http://xxl-job-admin/xxl-job-admin/;
proxy_set_header
Host
$host;
proxy_set_header
X-Real-IP
$remote_addr;
proxy_set_header
X-Forwarded-For
$proxy_add_x_forwarded_for;
proxy_set_header
X-Forwarded-Prefix
/xxl-job-admin;
proxy_set_header
X-Forwarded-Host
$http_x_forwarded_host;
proxy_set_header
X-NginX-Proxy
true;
}
error_page
500
502
503
504
/50x.html;
location
=
/50x.html
{
root
html;
}
}
server
{
listen
8080;
server_name
127.0.0.1;
#charset
koi8-r;
#access_log
logs/host.access.log
main;
root
html;
#前端页面代理
location
/
{
root
/opt/server/flood_prevention/web/dist;
#root
/opt/server/flood_prevention/web/webs;
index
index.html
index.htm;
}
#前端页面字体
location
/font/
{
alias
/opt/font/;
add_header
'Access-Control-Allow-Origin'
'*';
add_header
'Access-Control-Allow-Methods'
'GET,
POST,
OPTIONS';
add_header
'Access-Control-Allow-Headers'
'Origin,
Content-Type,
Accept,
Authorization';
}
#后台管理接口
location
/api/
{
proxy_pass
http://flood_prevention-api/;
proxy_set_header
Host
$host;
proxy_set_header
X-Real-IP
$remote_addr;
proxy_set_header
X-Forwarded-For
$proxy_add_x_forwarded_for;
proxy_set_header
X-Forwarded-Prefix
/api;
proxy_set_header
X-NginX-Proxy
true;
proxy_set_header
Upgrade
$http_upgrade;
proxy_set_header
Connection
"upgrade";
}
location
/file/
{
proxy_pass
http://admin-api/;
proxy_set_header
Host
$host;
proxy_set_header
X-Real-IP
$remote_addr;
proxy_set_header
X-Forwarded-For
$proxy_add_x_forwarded_for;
proxy_set_header
X-Forwarded-Proto
$scheme;
#
对于大文件/下载：避免
nginx
全部缓冲到磁盘/内存
proxy_buffering
off;
proxy_request_buffering
off;
proxy_http_version
1.1;
proxy_set_header
Connection
"";
proxy_redirect
off;
}
location
~
/ISAPI|SDK/
{
#
保持设备的
Host
请求头
proxy_set_header
Host
$host;
#
保持设备的
Referer
请求头
proxy_set_header
Referer
$http_referer;
proxy_set_header
Sec-Fetch-Site
"";
proxy_set_header
Sec-Fetch-Mode
"";
proxy_set_header
Sec-Fetch-Dest
"";
if
($http_cookie
~
"webVideoCtrlProxy=(.+)")
{
#
Nginx
示例：删除
Sec-Fetch-*
字段
proxy_pass
http://$cookie_webVideoCtrlProxy;
break;
}
}
location
^~
/webSocketVideoCtrlProxy
{
#web
socket
proxy_http_version
1.1;
proxy_set_header
Upgrade
$http_upgrade;
proxy_set_header
Connection
"upgrade";
#
保持设备的
Host
请求头
proxy_set_header
Host
$host;
#
保持设备的
Referer
请求头
proxy_set_header
Referer
$http_referer;
if
($http_cookie
~
"webVideoCtrlProxyWs=(.+)")
{
proxy_pass
http://$cookie_webVideoCtrlProxyWs/$cookie_webVideoCtrlProxyWsChannel?$args;
break;
}
if
($http_cookie
~
"webVideoCtrlProxyWss=(.+)")
{
proxy_pass
http://$cookie_webVideoCtrlProxyWss/$cookie_webVideoCtrlProxyWsChannel?$args;
break;
}
}
}
#飞来峡工程安全
server
{
listen
8085;
server_name
localhost;
location
/
{
root
/opt/flx-engineering-safe/flx-web;
index
index.html
index.htm;
try_files
$uri
$uri/
/index.html;
}
location
/api
{
proxy_pass
http://10.44.48.84:9082;
proxy_set_header
Host
$host;
proxy_set_header
X-Real-IP
$remote_addr;
proxy_set_header
X-Forwarded-For
$proxy_add_x_forwarded_for;
proxy_set_header
X-Forwarded-Proto
$scheme;
}
#
把
/file/*
映射到后端的
/api/*
（请确认后端真实
host:port，下面用
10.44.48.84:8226）
location
/file/
{
#
注意：使用后端主机为
10.44.48.84:8226（根据
curl
目标）
proxy_pass
http://10.44.48.84:8226/;
#
常用头部
proxy_set_header
Host
$host;
proxy_set_header
X-Real-IP
$remote_addr;
proxy_set_header
X-Forwarded-For
$proxy_add_x_forwarded_for;
proxy_set_header
X-Forwarded-Proto
$scheme;
#
对于大文件/下载：避免
nginx
全部缓冲到磁盘/内存
proxy_buffering
off;
proxy_request_buffering
off;
proxy_http_version
1.1;
proxy_set_header
Connection
"";
proxy_redirect
off;
}
#前端页面字体
location
/font/
{
alias
/opt/font/;
add_header
'Access-Control-Allow-Origin'
'*';
add_header
'Access-Control-Allow-Methods'
'GET,
POST,
OPTIONS';
add_header
'Access-Control-Allow-Headers'
'Origin,
Content-Type,
Accept,
Authorization';
}
}
}
}
